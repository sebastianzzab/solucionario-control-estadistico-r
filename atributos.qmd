---
title: "Diagramas de Control Aplicados con ${\\color{Blue} \\textbf{\\textsf{R}}}$"
author:
  - Andrea Rodriguez
  - Victor Rodriguez
  - Sebastian Zabala
format: html
author-title: |
      <p>AUTORES:</p>
title-block-banner: true
block-banner-color: "#FFDDFF"
html_align: justify
number-sections: true
number-depth: 4
highlight-style: github
code-fold: true
code-copy: true
code-block-bg: true
code-block-border-left: "#31BAE9"
code-block-border-left-size: 3px
callout-border-width: 1px
code-overflow: scroll
code-summary: "C칩digo"
html-math-method: mathjax
toc: true
toc-depth: 4
toc-location: right
toc-title: Contenido
theme:
- cosmo
# - r4ds.scss
code-line-numbers: true
# code-link: true
editor: visual
execute:
  warning: false
  message: false
  error: false
  abvertence: false
  echo: fenced
  cache: true
  freeze: auto 
lang: es

editor_options: 
  chunk_output_type: inline
---

```{r}
#| label: carga-paquetes
#| include: false
#| echo: false
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
library(pacman)
pacman::p_load(ggplot2,ggfortify, DT, reshape2, knitr,  tidyverse, ggQC, pammtools, latex2exp, data.table, reactable, htmlwidgets, htmltools, highcharter, tinytex, qcc, kableExtra)
```

```{r}
#| include: false

# Crear automaticamente una base de datos bib para los paquetes de R 
knitr::write_bib(
  c(
    .packages(), "knitr", "tidyverse", "qcc", "ggQC", "plotly",
    "highcharter", "kableExtra", "data.table", "pacman",
    "renv", "pammtools", "htmlwidgets", "htmltools", "data.table",
    "RColorBrewer", "latex2exp", "tinytex", "reactable"
  ),
  "packages.bib"
)

```

```{r}
#| label: funciones-creadas
#| include: false
#| echo: false

# funcion para ajustar fill-opacity usando css
fillOpacity <- function(., alpha = 0.5) {
  css <- sprintf("<style> .js-fill { fill-opacity: %s}
!important; } </style>", alpha)
  prependContent(., HTML(css))
}

# funcion para dar formato a numero
formato <- function(x, digits = 4) {
  if (!is.numeric(x)) stop("춰La entrada debe ser numerica!")
  format(
    round(x, digits = digits),
    mode = "double",
    big.mark = ".",
    decimal.mark = ","
  )
}

```

# Diagramas de Control para Atributos

<p style="text-align: justify;">

Este solucionario ha sido elaborado con base en los contenidos presentados en el libro *Control Estad칤stico de la Calidad*, desarrollado por el profesor **Oswaldo Bello** como material de apoyo para la asignatura del mismo nombre en la Universidad de Oriente, N칰cleo Nueva Esparta.

El libro est치 disponible en l칤nea en el siguiente enlace:  
游댕 [https://oswaldobelloc.github.io/libro_cec/](https://oswaldobelloc.github.io/libro_cec/)

Fue desarrollado por estudiantes de la carrera de Licenciatura en Estad칤stica utilizando Quarto. Contiene ejemplos de los principales diagramas de control para atributos (`np`, `p`, `c`, `u`), aplicados con el lenguaje de programaci칩n R. Cada gr치fico fue generado con el paquete `highcharter`, por su capacidad de generar visualizaciones interactivas y atractivas.

Este material tiene fines tanto evaluativos como educativos, sirviendo de gu칤a para futuros cursos.

</p>

## Diagrama $np$

El diagrama $np$ se utiliza para monitorear el n칰mero de unidades defectuosas en un proceso de producci칩n. Se aplica espec칤ficamente cuando el tama침o de la muestra es constante, permitiendo a los analistas observar la variabilidad en el n칰mero de defectos a lo largo del tiempo.


:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcnp .Example}
### Aplicaci칩n del Diagrama $np$ {#sec-ejemplo-diagrama-np}

<p style="text-align: justify;">

Del an치lisis de los datos de inspecciones y pruebas finales de un producto ensamblado se detect칩 a trav칠s de una estratificaci칩n y un an치lisis de Pareto que la causa principal por la que los art칤culos salen defectuosos est치 relacionada con los problemas de un componente en particular (el componente k12). Por lo tanto, se decide analizar m치s de cerca el proceso que produce tal componente. Para ello, de cada lote de componentes k12 se decide inspeccionar una muestra de n = 120. Los datos obtenidos en 20 lotes consecutivos se muestran en la @tbl-datos-ejemplo1-dcnp. Como n es constante, la cantidad de defectuosos por muestra se puede analizar con una carta $np$.

</p>

```{r}
#| label: tbl-datos-ejemplo1-dcnp
#| tbl-cap: "N칰mero de componentes k12 defectuosos por lote"
#| tbl-align: left

datos_np <- data.table::data.table(
  muestra = c(
    1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L
  ),
  Di = c(
    9L, 6L,10L, 8L, 5L, 5L, 14L, 12L, 9L, 8L, 10L, 20L, 12L, 10L, 10L, 0L, 13L, 5L, 6L, 11L
  )
)
options(
  reactable.language = reactableLang(
    searchPlaceholder = "Search...",
    pageNext = "Siguiente",
    pagePrevious = "Anterior",
    noData = "No entries found",
    pageInfo = "{rowStart} de {rowEnd} de {rows} filas"
  )
)

reactable::reactable(
  datos_np,
  columns = list(
    muestra = colDef(header = "Muestra"),
    Di = colDef(
      header = "N칰mero  de Componentes defectuosos"
    )
  ),
  defaultColDef = colDef(
    # footer = function(values, name) {
    #   htmltools::div(name, style = list(fontWeight = 600))
    # },
    align = "center",
    minWidth = 100,
    # maxWidth = 200
  ),
  fullWidth = TRUE,
  # width = "100%",
  # style = list(width = "100%"),
  resizable = TRUE, 
  wrap = FALSE, 
  bordered = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  highlight = TRUE,
  filterable = TRUE
)
```

En primer lugar, se necesita calcular el numero promedio de componentes defectuosos en k12 por lotes, representado por $\hat{p}$, el cual se obtiene mediante la expresi칩n matem치tica:

$$
\begin{equation}
\bar{p}=\frac{\sum_{i=1}^{m}d_{i}}{n*m}
\end{equation}
$$ {#eq-pestnp}

Por lo que se obtiene de dividir el total de art칤culos defectuosos (183) entre el total de piezas inspeccionadas (20 muestras de 120 piezas cada una). Al reemplazar los datos en la @eq-pestnp, se tiene:

$$\hat{p} = \frac{183}{20 \times 120} = 0.07625$$

Con R, se obtiene de la siguiente manera:

```{r}
#| label: cp-dcnp

m <- nrow(datos_np)
n <- 120
p_est <- sum(datos_np$Di) / (n * m)
```

Para la estimaci칩n de los limites de control, se hace uso de la carta de control de Shewhart, donde los limites vienen dados por las siguientes expresiones:

$$
\begin{align}
LCS = n\bar{p}+3\sqrt{n\bar{p}(1-\bar{p})} \\
LC = n\bar{p} \\ 
LCI = n\bar{p}-3\sqrt{n\bar{p}(1-\bar{p})}
\end{align}
$$ {#eq-lcnp}

Al sustituir los datos en @eq-lcnp, con R se obtiene lo siguiente:

```{r}
#| label: lci-dcnp
#| tbl-align: left

lic <- max(0, n * p_est - 3 * sqrt(n * p_est * (1 - p_est)))
lc <- n * p_est
lsc <- n * p_est + 3 * sqrt(n * p_est * (1 - p_est))
paste0("LCS = ", formato(lsc), "    LC = ", formato(lc), "    LCI = ", formato(lic))
```

Una vez determinado los l칤mites de control ya es posible realizar el grafico de control con los limites calculados. El cual se puede ver a continuaci칩n:

```{r}
#| label: fig-ejemplo-dcnp-highcharter
#| fig-cap: "Diagrama $np$ para el numero de art칤culos defectuosos"

highchart() |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 4)
  ) |>
  hc_add_series(
    data = datos_np, hcaes(x = muestra, low = lc, high = lsc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.3, name = "", color = "green",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 0)
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = Di),
    useHTML = TRUE, color = "black", name = "<b><i>D<sub>i</sub></i></b>",
    dashStyle = "Dash",
    marker = list(
      symbol = "circle", fillColor = "white", radius = 3,
      lineWidth = 2, lineColor = "black"
    )
  ) |>
  hc_add_series(
    data = datos_np, hcaes(x = muestra, low = lic, high = lc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.3, name = "", color = "blue",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>N칰mero de art칤culos defectuosos (d<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE) |> 
  hc_plotOptions( series = list(animation = FALSE) )
```

<p style="text-align: justify;">

De la @fig-ejemplo-dcnp-highcharter se aprecia que el proceso no funcion칩 de manera estable, ya que el n칰mero de piezas defectuosas en la muestra del lote 12 es mayor que el l칤mite superior; mientras que en la muestra del lote 16 el n칰mero de defectuosos es menor que el l칤mite inferior. De aqu칤 que se tenga una evidencia objetiva para afirmar que en la fabricaci칩n del lote 12 se present칩 una causa o situaci칩n especial que normalmente no est치 presente en el proceso y que lo empeor칩 de forma seria; mientras que en el lote 16 ocurri칩 una causa especial que mejor칩 el desempe침o del proceso de fabricaci칩n de componentes k12. Es necesario localizar ambas causas, ya que as칤 se estar치 en posibilidades de prevenir la primera, y en caso de no haber un error en el registro de los datos, fomentar la segunda. Con el fin de establecer una estimaci칩n de $p$ que ayude a supervisar las producciones futuras, el diagrama debe ser recalculado a partir de la estimaci칩n de $p$, utilizando la @eq-pestnp, eliminando estas observaciones.

</p>

```{r}
#| include: FALSE
#| label: lci-dcnp-2
#| tbl-align: left

datos_np <- datos_np[-c(12,16),]
m <- nrow(datos_np)
p_est <- sum(datos_np$Di) / (n * m)

lic_tmp <- max(0, n * p_est - 3 * sqrt(n * p_est * (1 - p_est)))
lc <- n * p_est
lsc_tmp <- n * p_est + 3 * sqrt(n * p_est * (1 - p_est))

```

La nueva estimaci칩n de $p$ ser칤a $`r formato(p_est)`$ y los limites de control superior e inferior ser칤an $`r formato(lsc_tmp)`$ y $`r formato(lic_tmp)`$, respectivamente.

```{r}
#| label: fig-ejemplo-dcnp2-highcharter
#| fig-cap: "Diagrama $np$ para el numero de art칤culos defectuosos"

highchart() |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 4)
  ) |>
  hc_add_series(
    data = datos_np, hcaes(x = muestra, low = lc, high = lsc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.3, name = "", color = "green",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 0)
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>",
    step = "center", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_np,
    type = "line", hcaes(x = muestra, y = Di),
    useHTML = TRUE, color = "black", name = "<b><i>D<sub>i</sub></i></b>",
    dashStyle = "Dash",
    marker = list(
      symbol = "circle", fillColor = "white", radius = 3,
      lineWidth = 2, lineColor = "black"
    )
  ) |>
  hc_add_series(
    data = datos_np, hcaes(x = muestra, low = lic, high = lc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.3, name = "", color = "blue",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>N칰mero de art칤culos defectuosos (d<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE) |> 
  hc_plotOptions( series = list(animation = FALSE) )
```

Se observa em @fig-ejemplo-dcnp2-highcharter que eliminando las observaciones que estuvieron fuera de control, el proceso entra en estado bajo control. Por lo que, se concluye que la estimaci칩n de $p$ ($\bar{p}=`r formato(p_est)`$) es correcta para la supervisi칩n futura de la producci칩n de de componentes k12.
:::
::::

## Diagrama $p$

El diagrama $p$ muestra las variaciones en la proporci칩n de art칤culos defectuosos por muestra o subgrupo. Es ampliamente usada para evaluar el desempe침o de una parte o de todo un proceso, tomando en cuenta su variabilidad con el prop칩sito de detectar causas o cambios especiales en el proceso.


:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcp .Example}
### Aplicaci칩n del Diagrama $p$ {#sec-ejemplo-diagrama-p}

<p style="text-align: justify;">

En una f치brica de art칤culos de pl치stico inyectado se tiene el problema de la rebaba en las piezas, que es necesario eliminar con retrabajo. Con el prop칩sito de evaluar la realidad actual y detectar posibles causas especiales de variaci칩n se decide implementar una carta de control para el producto que m치s se fabrica, los datos obtenidos en 24 lotes de tama침o 500, en cuanto a la cantidad de piezas con rebaba como tambi칠n su fracci칩n de defectos se muestra en la @tbl-datos-ejemplo1-dcp:

</p>

```{r}
#| label: tbl-datos-ejemplo1-dcp
#| tbl-cap: "Cantidad de piezas con rebaba en cada muestra"
#| tbl-align: left

datos1_p <- data.table::data.table(
  muestra = c(
    1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L, 10L, 11L, 12L,
    13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L, 22L, 23L, 24L
  ),
  Di = c(86L, 95L, 113L, 93L, 88L, 101L, 90L, 85L, 111L, 80L, 96L, 89L,
    98L, 126L, 96L, 124L, 129L, 115L, 95L, 78L, 97L, 110L, 108L, 118L
  ),
  Pi = c(86L, 95L, 113L, 93L, 88L, 101L, 90L, 85L, 111L, 80L, 96L, 89L,
    98L, 126L, 96L, 124L, 129L, 115L, 95L, 78L, 97L, 110L, 108L, 118L
  )/500
)

options(
  reactable.language = reactableLang(
    searchPlaceholder = "Search...",
    pageNext = "Siguiente",
    pagePrevious = "Anterior",
    noData = "No entries found",
    pageInfo = "{rowStart} de {rowEnd} de {rows} filas"
  )
)

reactable::reactable(
  datos1_p,
  columns = list(
    sample = colDef(header = "Muestra", align = "right"),
    D = colDef(
      header = "Cantidad de piezas con rebasa", 
      align = "right"
    ),
    size = colDef(header = "Tama침o de la muestra", align = "right"),
    trial = colDef(header = "Primer ensayo", align = "left")
  ),
  defaultColDef = colDef(
    # footer = function(values, name) {
    #   htmltools::div(name, style = list(fontWeight = 600))
    # },
    minWidth = 100,
    # maxWidth = 200
  ),
  fullWidth = TRUE,
  # width = "100%",
  # style = list(width = "100%"),
  resizable = TRUE, 
  wrap = FALSE, 
  bordered = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  highlight = TRUE,
  filterable = TRUE
)
```

Se requieren los parametros para construir el diagrama de control. Nuevamente como no se tiene conocimiento sobre los parametros del proceso se tienen que estimar. Nuevamente se estima $p$ a traves de $\hat{p}$ a trav칠s de la @eq-pestnp. Cuyo resultado con R es el siguiente:

```{r}
#| label: p-est-dcp-1
m <- nrow(datos1_p)
n <- 500
p_est <- sum(datos1_p$Di) / (n * m)
paste0(formato(p_est))
```

Con el resultado anterior ya es posible calcular los limites de control a trav칠s de la siguiente formula:

$$
\begin{align}
LCS = \bar{p}+3\sqrt{\bar{p}(1-\bar{p})} \\
LC = \bar{p} \\ 
LCI = \bar{p}-3\sqrt{\bar{p}(1-\bar{p})}
\end{align}
$$ {#eq-lcp}

Sustituyendo los datos de la @tbl-datos-ejemplo1-dcp en la @eq-lcp, se tienen los siguientes resultados:

```{r}
#| label: lci-dcp-1

lic <- max(0, p_est - 3 * sqrt(p_est * (1 - p_est) / n))
lc <- p_est
lsc <- p_est + 3 * sqrt(p_est * (1 - p_est) / n)
paste0("LCI = ", formato(lic), "    LC = ", formato(lc), "    LCS = ", formato(lsc))
```

Una vez calculado los limites de control ya es posible realizar el diagrama. El cual se ve de la siguiente manera:

```{r}
#| label: fig-ejemplo-dcp-highcharter
#| fig-cap: "Diagrama p para la cantidad de piezas con rebaba"

highchart() |>
  hc_chart(type = "line") |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "center", marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>", step = "center",
    marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "center", marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = Di / n),
    useHTML = TRUE, color = "black", name = "<b><i>p<sub>i</sub></i></b>",
    dashStyle = "Dash",
    marker = list(
      symbol = "circle", fillColor = "white", radius = 3,
      lineWidth = 2, lineColor = "black"
    )
  ) |>
  hc_add_series(
    data = datos1_p, hcaes(x = muestra, low = lc, high = lsc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "green", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos1_p, hcaes(x = muestra, low = lic, high = lc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "blue", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Fracci칩n de de piezas con rebasa</i></b><br>"
    )
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE, valueDecimals = 4)
```

Como se puede observar en la @fig-ejemplo-dcp-highcharter, se encuentra un punto fuera del l칤mite superior asociado a la muestra n칰mero 17. Por lo que suponiendo que dicho punto tenga causas atribuibles se puede decir que el proceso est치 fuera de control. Por consiguiente, se sugiere su exclusi칩n con el fin de establecer una estimaci칩n de $p$ que ayude a supervisar las producciones futuras, el diagrama debe ser recalculado a partir de la estimaci칩n de $p$, utilizando la @eq-pestnp, eliminando esta observaci칩n como se puede observar en R:

```{r}
#| label: lci-dcp-2
#| tbl-align: left

datos1_p <- datos1_p[-c(17),]

p_est <- sum(datos1_p$Di) / (n * m)

lic_tmp <- max(0,p_est - 3 * sqrt(p_est * (1 - p_est)/ n))
lc <- p_est
lsc_tmp <- p_est + 3 * sqrt(p_est * (1 - p_est)/ n)

```

La nueva estimaci칩n de $p$ ser칤a $`r formato(p_est)`$ y los limites de control superior e inferior ser칤an $`r formato(lsc_tmp)`$ y $`r formato(lic_tmp)`$, respectivamente. Por lo que ya se puede construir el diagrama de control con los nuevos valores. El cual es el siguiente:

```{r}
#| label: fig-ejemplo-dcp2-highcharter
#| fig-cap: "Diagrama p para la cantidad de piezas con rebaba"

highchart() |>
  hc_chart(type = "line") |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "center", marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>", step = "center",
    marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "center", marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos1_p,
    type = "line", hcaes(x = muestra, y = Di / n),
    useHTML = TRUE, color = "black", name = "<b><i>p<sub>i</sub></i></b>",
    dashStyle = "Dash",
    marker = list(
      symbol = "circle", fillColor = "white", radius = 3,
      lineWidth = 2, lineColor = "black"
    )
  ) |>
  hc_add_series(
    data = datos1_p, hcaes(x = muestra, low = lc, high = lsc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "green", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos1_p, hcaes(x = muestra, low = lic, high = lc),
    step = "center", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "blue", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Fracci칩n de piezas con rebada</i></b><br>"
    )
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE, valueDecimals = 4)
```

Se observa en la @fig-ejemplo-dcp2-highcharter que eliminando la observaci칩n que estuvo fuera de control, el proceso entra en estado bajo control. Por lo que, se concluye que la estimaci칩n de $p$ ($\bar{p}=`r formato(p_est)`$) es correcta para la supervisi칩n futura de la producci칩n de piezas con rebada.
:::
::::

:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcp-tmv .Example}
### Aplicaci칩n del Diagrama $p$ con Tama침o de Muestra Variable {#sec-ejemplo-diagrama-p-tmv}

<p style="text-align: justify;">

En una empresa del ramo metalmec치nico se fabrican v치lvulas. Despu칠s del proceso de fundici칩n se realiza una inspecci칩n y las piezas que no cumplen con ciertas caracter칤sticas son rechazadas. Las razones del rechazo son diversas: piezas incompletas, porosas, mal formadas, etc. Para evaluar la variabilidad y la magnitud de la proporci칩n de piezas defectuosas en el proceso de fundici칩n se decide implementar una carta $p$. El proceso de fundici칩n se hace por lotes. En la @tbl-datos-dcp-tmv se muestran los datos obtenidos durante una semana para cierto tipo de v치lvulas. Aunque regularmente el tama침o de lote es fijo, n = 300, en ocasiones, por diferentes motivos, en algunos lotes se hacen unas cuantas piezas de m치s o de menos.

</p>

```{r}
#| label: tbl-datos-dcp-tmv
#| tbl-cap:  "Datos para el diagrama $p$ con tama침o de muestra variables"
#| tbl-align: left

datos_dpv <- data.table::data.table(
  muestra = 1:21,
  ni = c(
    300L, 300L, 300L, 300L, 300L, 300L, 300L, 280L, 290L, 300,
    300L, 300L, 300L, 300L, 305L, 295L, 300L, 300L, 300L, 300L,
    300L
  ),
  di = c(
    15L, 12L,   15L,   7L,   16L,  6L,   18L,  10L,  9L,   15L, 
    9L,   4L,    7L,   9L,    5L, 15L,   19L,   7L, 12L,   10L, 
    4L
  )
)

p_est <- sum(datos_dpv$di) / sum(datos_dpv$ni)

datos_dpv <- datos_dpv |> 
  dplyr::mutate(
    pi = di / ni,
    desviacion = sqrt(p_est * (1 - p_est) / ni),
    lic = ifelse(p_est - 3 * desviacion >= 0, p_est - 3 * desviacion, 0),
    lsc = p_est + 3 * desviacion
  )
knitr::kable(
  datos_dpv,
  table.attr = 'data-quarto-disable-processing="true"',
  booktabs = TRUE,
  format = "markdown",
  digits = 4,
  format.args = list(decimal.mark = ",", big.mark = "."),
  col.names = c(
    "N칰mero de muestra $i$",
    "Tama침o de la muestra",
    "N칰mero de unidades disconformes $D_i$",
    "Fracci칩n disconforme muestral $\\hat{p}_i$",
    "Desviaci칩n est치ndar $\\sqrt {\\frac{\\bar{p}(1 - \\bar{p})}{n_i}}$",
    "L칤mite inferior de control $LCI_i$",
    "L칤mite superior de control $LCS_i$"
  ),
  align = "ccccccc",
  caption = "\\label{tbl-datos-dcp-tmv}Datos para el diagrama $p$ con tama침o de muestra variables",
  escape = FALSE
)
```

La estimaci칩n de $p$ se obtiene mediante la siguiente expresi칩n:

$$
\begin{equation}
\bar{p}=\frac{\sum_{i=1}^{m}d_i}{\sum_{i=1}^{m}n_i}
\end{equation}
$$ {#eq-pestp}

La desviaci칩n estandar viene dada por:

$$
\begin{equation}
\sqrt{\frac{\bar{p}(1-\bar{p})}{n_i}}
\end{equation}
$$ {#eq-desvp}

Los limites de control son calculados mediante las siguientes expresiones:

$$
\begin{align}
LCS_i = \bar{p}+3\sqrt{\frac{\bar{p}(1-\bar{p})}{n_i}} \\
LC = \bar{p} \\ 
LCI_i = \bar{p}-3\sqrt{\frac{\bar{p}(1-\bar{p})}{n_i}}
\end{align}
$$

Se observa en la @tbl-datos-dcp-tmv que las variaciones en los limites de control son m칤nimas, esto debido a la similitud en los tama침os de muestra. Por ello, resulta m치s practica la estimaci칩n de estos limites utilizando el promedio de los $n$ subgrupos. De la siguiente forma:

```{r}
#| include: FALSE
#| label: cp-dcp-lc-dcp-tmv

m <- nrow(datos_dpv)
n_est <- sum(datos_dpv$ni) / (m)
 desviacion = sqrt(p_est * (1 - p_est) / round(n_est,0))
lic_tmp <- ifelse(p_est - 3 * desviacion >= 0, p_est - 3 * desviacion, 0)
lc <- p_est
lsc_tmp <- p_est + 3 * desviacion
```

$$
\begin{equation}
\bar{n}=\frac{\sum_{i}^{m}n_i}{m}
\end{equation}
$$ {#eq-nest}

Al reemplazar los datos se tiene que:

$$
\bar{n}=\frac{
`r datos_dpv[1, 2]` + `r datos_dpv[2, 2]` + \cdots + `r datos_dpv[nrow(datos_np) - 1, 2]` + `r datos_dpv[nrow(datos_np), 2]`}{`r nrow(datos_dpv)`} = `r formato(n_est)`.
$$

Aproximando al entero m치s cercano, se tiene que $\bar{n}= `r round(n_est,0)`$

Por lo que ahora se calculan los nuevos limites de control utilizando la @eq-lcp, con la salvedad de que se utiliza $\bar{n}$ como estimador de los $n_i$.

$$
LCS = `r p_est`+3\sqrt{\frac{`r p_est`(1-`r p_est`)}{`r round(n_est,0)`})} = `r lsc_tmp`
$$

$$
LC= `r p_est`=`r lc`
$$

$$
LCI = `r p_est`-3\sqrt{\frac{`r p_est`(1-`r p_est`)}{`r round(n_est,0)`})} = `r lic_tmp`
$$

De modo que, el diagrama de control con los l칤mites calculados ser칤a el siguiente:

```{r}
#| label: fig-dcp-tmv-highcharter
#| fig-cap: "Diagrama p para el n칰mero de piezas de valvulas defectuosas"

datos_dpv$outlier <- ifelse(
  datos_dpv$pi < datos_dpv$lic | datos_dpv$pi > datos_dpv$lsc, "Si", "No"
)

color <- ifelse(
  datos_dpv$outlier == "No", "#0000FF", "#FF0000" 
)
symbol <- ifelse(
  datos_dpv$outlier == "No", "triangle-up", "triangle-down"
)

# library(highcharter)
highchart() |>
  hc_add_series(
    datos_dpv,
    type = "line", hcaes(x = muestra, y = p_est), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>", step = "hv",
    marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos_dpv,
    type = "line", hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", name = "<b><i>LCS</b></i>", dashStyle = "Dash",
    step = "hv", marker = list(enabled = FALSE)
  ) |>
  hc_add_series(
    datos_dpv,
    type = "line", hcaes(x = muestra, y = pi, color = color, symbol = symbol),
    useHTML = TRUE, color = "black", 
    name = "<b><i>p<sub>i</sub></i></b>",
    dashStyle = "Dash",
    marker = list(radius = 3)
  ) |>
  hc_add_series(
    data = datos_dpv, hcaes(x = muestra, low = lsc, high = p_est),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "green", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos_dpv, hcaes(x = muestra, low = lic, high = p_est),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, color = "blue", name = "",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_dpv,
    type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", name = "<b><i>LCI</b></i>", dashStyle = "Dash",
    step = "hv", marker = list(enabled = FALSE)
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Fracci칩n de unidades defectuosas (p<sub>i</sub>)</i></b><br>"
    ),
    min = 0,
    max = 0.1
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE, valueDecimals = 4)
```

Como se puede observar en la @fig-dcp-tmv-highcharter el proceso funciona bajo control. Por lo que a la empresa del ramo metalmec치nico que fabrican v치lvulas las estimaciones realizadas les serviran de base para proximas inspecciones de los lotes de piezas en el proceso de fundici칩n, para evaluar si el proceso sigue o no bajo control.
:::
::::

## Diagrama $c$

El diagrama $c$ analiza la variabilidad del n칰mero de defectos en un proceso. Se aplica espec칤ficamente cuando el tama침o de la muestra o subgrupo se mantiene constante. permite visualizar y monitorear el n칰mero de defectos encontrados al inspeccionar unidades de producto o servicio, ayudando a identificar tendencias o variaciones en el proceso de producci칩n.

:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcc .Example}
### Aplicaci칩n del Diagrama $c$ {#sec-ejemplo-diagrama-c}

Con el prop칩sito de analizar la posibilidad de eliminar los est치ndares de trabajo en un sector de una f치brica, se decide analizar el n칰mero de cierto tipo de operaciones que realiza cada trabajador por d칤a y semana. A continuaci칩n se muestran los resultados obtenidos en una semana para 14 trabajadores (cada dato corresponde a un trabajador). Calcule los l칤mites de control para una carta c para el n칰mero de operaciones por trabajador e interprete los l칤mites que obtenga.

```{r}
#| label: tbl-datos-ejemplo-dcc
#| tbl-cap: "N칰mero promedio de operaciones por trabajador por  d칤a y semana"
#| tbl-cap-align: left
#| tbl-align: left

datos_c <- tibble(
  muestra = 1:14,
  Ci = c(
    295, 306, 292, 297, 294, 343, 285, 240, 329, 305, 277, 260, 337, 320
  )
)

reactable::reactable(
  datos_c,
  columns = list(
    muestra = colDef(header = "Muestra", align = "right"),
    Ci = colDef(
      header = "N칰mero promedio de operaciones por trabajador", 
      align = "right"
    )
  ),
  defaultColDef = colDef(
    # footer = function(values, name) {
    #   htmltools::div(name, style = list(fontWeight = 600))
    # },
    minWidth = 100,
    # maxWidth = 200
  ),
  fullWidth = TRUE,
  # width = "100%",
  # style = list(width = "100%"),
  resizable = TRUE, 
  wrap = FALSE, 
  bordered = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  highlight = TRUE,
  filterable = TRUE
)
```

La estimaci칩n de $c$ se obtiene mediante la siguiente expresi칩n:

$$
\begin{equation}
\bar{c}=\hat{c}=\frac{\sum_{i=1}^{m}c_i}{m}
\end{equation}
$$ {#eq-pestc}

```{r}
#| include: FALSE
c_est <- mean(datos_c$Ci)
```

Al sustituir los datos de la @tbl-datos-ejemplo-dcc, se tiene: $$
\hat{c} = \bar{c} = \frac{`r datos_c[1, 2]` + `r datos_c[2, 2]` + \cdots + `r datos_c[nrow(datos_c) - 1, 2]` + `r datos_c[nrow(datos_c), 2]`}{`r m`}=`r c_est`
$$

La desviaci칩n estandar viene dada por:

$$
\begin{equation}
\sqrt{\bar{c}}
\end{equation}
$$ {#eq-desvc}

Los limites de control son calculados mediante las siguientes expresiones:

$$
\begin{align}
LCS_i = \bar{c}+3\sqrt{\bar{c}} \\
LC = \bar{c} \\ 
LCI_i = \bar{c}-3\sqrt{\bar{c}}
\end{align}
$$ {#eq-lcc}

Reemplazando, se tiene entonces que:

$$
LCS = `r c_est` + 3\sqrt {`r c_est`} = `r lsc`
$$

$$
LC=`r c_est`
$$

$$
LCI = `r c_est` - 3\sqrt {`r c_est`} = `r lic`
$$ Y en la @fig-ejemplo-dcc-highcharter se puede aprecia el diagrama de control para esta serie de datos.

Por otro lado, los par치metros del Diagrama tambi칠n se calculan en R y se muestra esto en el siguiente bloque de c칩digo:

```{r}
#| label: lci-dcc
m <- nrow(datos_c)
lic <- max(0, c_est - 3 * sqrt(c_est))
lc <- c_est
lsc <- c_est + 3 * sqrt(c_est)
paste0("LCI = ", formato(lic), "    LC = ", formato(lc), "    LCS = ", formato(lsc))
```

El diagrama de control es el siguiente:

```{r}
#| label: fig-ejemplo-dcc-highcharter
#| fig-cap: "Diagrama $c$ para el n칰mero defectos"


datos_c <- datos_c |> 
  mutate(
    fc = ifelse(Ci > lsc | Ci < lic, "Si", "No"),
    color = ifelse(fc == "Si", "#FF0000", "#0000FF"),
    symbol = ifelse(fc == "Si", "asterisk-open", "circle")
  )

highchart() |>
  
  hc_add_series(
    data = datos_c, hcaes(x = muestra, low = lc, high = lsc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "green",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos_c, hcaes(x = muestra, low = lic, high = lc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "blue",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_c, type = "line", 
    hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 4)
  ) |>
  hc_add_series(
    datos_c,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_c, type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list( valueDecimals = 0)
  ) |>
  hc_add_series(
    datos_c,
    type = "line", color = "black",
    hcaes(
      x = muestra, y = Ci, color = color, symbol = symbol
    ),
    marker = list(
      radius = 3
    ),
    useHTML = TRUE, name = "<b><i>C<sub>i</sub></i></b>",
    dashStyle = "Dash"
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  
  hc_yAxis(
  title = list(
    useHTML = TRUE,
    text = "<b><i>N칰mero de operaciones por trabajador (C<sub>i</sub>)</i></b><br>"
  )
) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE) |> 
  hc_plotOptions( series = list(animation = FALSE) )
```

Como se puede observar en la @fig-ejemplo-dcc-highcharter, se tiene que un punto se encuentra fuera de los limites de control, siendo este asociado al octavo trabajador. Significando que el desempe침o de ese trabajador no sigue el comportamiento com칰n del resto, y hay una causa especial de variaci칩n que debe ser investigada. Por lo que en primera instancia se debe investigar la causa especial de variaci칩n (si es que existe), la cual puede deberse a problemas de salud o fatiga esa semana, recepci칩n de tareas distintas o fue asignado a un diferente, entre otros. Suponiendo que fue investigada y se determina que el trabajador no segu칤a el proceso est치ndar, entonces se excluira su dato para recalcular l칤mites de control sin distorsi칩n. Esto ultimo se hace en el siguiente bloque de c칩digo en R:

```{r}
datos_c <- datos_c[-c(8),]
m <- nrow(datos_c)
c_est <- mean(datos_c$Ci)
lic_tmp <- max(0, c_est - 3 * sqrt(c_est))
lc <- c_est
lsc_tmp <- c_est + 3 * sqrt(c_est)
paste0("LCI = ", formato(lic), "    LC = ", formato(lc), "    LCS = ", formato(lsc))
```

El diagrama de control ahora es el siguiente:

```{r}
#| label: fig-ejemplo-dcc-highcharter-2
#| fig-cap: "Diagrama $c$ para el n칰mero defectos"


datos_c <- datos_c |> 
  mutate(
    fc = ifelse(Ci > lsc | Ci < lic, "Si", "No"),
    color = ifelse(fc == "Si", "#FF0000", "#0000FF"),
    symbol = ifelse(fc == "Si", "asterisk-open", "circle")
  )

highchart() |>
  
  hc_add_series(
    data = datos_c, hcaes(x = muestra, low = lc, high = lsc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "green",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos_c, hcaes(x = muestra, low = lic, high = lc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "blue",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_c, type = "line", 
    hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 4)
  ) |>
  hc_add_series(
    datos_c,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_c, type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list( valueDecimals = 0)
  ) |>
  hc_add_series(
    datos_c,
    type = "line", color = "black",
    hcaes(
      x = muestra, y = Ci, color = color, symbol = symbol
    ),
    marker = list(
      radius = 3
    ),
    useHTML = TRUE, name = "<b><i>C<sub>i</sub></i></b>",
    dashStyle = "Dash"
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  
  hc_yAxis(
  title = list(
    useHTML = TRUE,
    text = "<b><i>N칰mero de operaciones por trabajador (C<sub>i</sub>)</i></b><br>"
  )
) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE) |> 
  hc_plotOptions( series = list(animation = FALSE) )
```

Como se puede observar ahora en la @fig-ejemplo-dcc-highcharter-2 ya el proceso esta bajo control. Por lo que los est치ndares de trabajo de la f치brica, se pueden representar bajo los limites establecidos para proximos estudios del n칰mero de operaciones que realiza cada trabajador por d칤a y semana.
:::
::::

## Diagrama $u$

El diagrama $u$ permite monitorear el n칰mero promedio de defectos por unidad en un proceso de producci칩n. es especialmente 칰til cuando el tama침o de las muestras var칤a, lo que permite un an치lisis m치s flexible y adaptado a diferentes situaciones de producci칩n. Permite a las organizaciones evaluar la calidad de sus productos al registrar el n칰mero promedio de defectos por unidad, incluso cuando el tama침o de las muestras no만s맊onstante.

:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcu .Example}
### Aplicaci칩n del Diagrama $u$

En una f치brica de productos de pl치stico se tiene el problema de las rugosidades (o marcas de fl ujo) que no su funcionamiento. Con el prop칩sito de analizar la estabilidad del proceso y tratar de localizar causas especiales de variaci칩n, se inspeccionan 50 piezas de cada lote de cierto producto. El n칰mero de rugosidades encontradas en los lotes producidos en dos semanas se muestra a continuaci칩n:

```{r}
#| label: tbl-datos-ejemplo1-dcu
#| tbl-cap: "N칰mero de rugosidades encontradas en los lotes producidos en dos semanas"
#| tbl-cap-align: left
#| tbl-align: left

datos_u <- tibble(
  muestra = 1:22,
  Ci = c(
    155L, 181L, 158L, 156L, 152L, 188L, 163L, 163L, 170L, 154L, 150L, 188L, 155L, 141L, 163L, 154L, 153L, 167L, 128L, 153L, 129L, 160L
  ),
  Ui = c(
    155L, 181L, 158L, 156L, 152L, 188L, 163L, 163L, 170L, 154L, 150L, 188L, 155L, 141L, 163L, 154L, 153L, 167L, 128L, 153L, 129L, 160L) / 50L
  )

reactable::reactable(
  datos_u,
  columns = list(
    muestra = colDef(header = "Muestra", align = "right"),
    Ui = colDef(
      header = "N칰mero de rugosidades por pieza", 
      align = "right"
    )
  ),
  defaultColDef = colDef(
    # footer = function(values, name) {
    #   htmltools::div(name, style = list(fontWeight = 600))
    # },
    minWidth = 100,
    # maxWidth = 200
  ),
  fullWidth = TRUE,
  # width = "100%",
  # style = list(width = "100%"),
  resizable = TRUE, 
  wrap = FALSE, 
  bordered = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  highlight = TRUE,
  filterable = TRUE
)
```

La estimaci칩n de $u$ se obtiene mediante la siguiente expresi칩n:

$$
\begin{equation}
\bar{u}=\frac{\sum_{i=1}^{m}c_i}{nm}
\end{equation}
$$ {#eq-uest}

La desviaci칩n estandar viene dada por:

$$
\begin{equation}
\sqrt{\frac{\bar{u}}{n}}
\end{equation}
$$ {#eq-desvu}

Los limites de control son calculados mediante las siguientes expresiones:

$$
\begin{align}
LCS_i = \bar{u}+3\sqrt{\frac{\bar{u}}{n}} \\
LC = \bar{u} \\ 
LCI_i = \bar{u}-3\sqrt{\frac{\bar{u}}{n}}
\end{align}
$$ {#eq-lcu}

```{r}
#| label: lci-dcu
m <- nrow(datos_u)
n <- 5
u_est <- mean(datos_u$Ui)
lic <- max(0, u_est - 3 * sqrt(u_est / n))
lc <- u_est
lsc <- u_est + 3 * sqrt(u_est / n)
paste0("LCI = ", formato(lic), "    LC = ", formato(lc), "    LCS = ", formato(lsc))
```

Al sustituir los datos de la @tbl-datos-ejemplo1-dcu, se tiene:

$$
\bar{u} = \frac{`r datos_u[1, 2]` + `r datos_u[2, 2]` + \cdots + `r datos_u[nrow(datos_u) - 1, 2]` + `r datos_u[nrow(datos_u), 2]`}{50 * `r m`}=`r u_est`
$$ La estimaci칩n de $u$ es de `r formato(u_est)`.

La desviaci칩n estandar viene dada por: $$
\sqrt{\frac{`r u_est`}{`r n`}} = `r formato(sqrt(u_est / n))`
$$ Los limites de control son calculados mediante las siguientes expresiones: $$
LCS = `r u_est` + 3\sqrt{\frac{`r u_est`}{`r n`}} = `r lsc`
$$ $$
LC = `r u_est` = `r lc`
$$ $$
LCI = `r u_est` - 3\sqrt{\frac{`r u_est`}{`r n`}} = `r lic`
$$ El diagrama de control es el siguiente:

```{r}
#| label: fig-ejemplo-dcu-highcharter
#| fig-cap: "Diagrama $u$ para el n칰mero de rugosidades por pieza"

# library(highcharter)
highchart() |>
  hc_add_series(
    data = datos_u, hcaes(x = muestra, low = lc, high = lsc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "green",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    data = datos_u, hcaes(x = muestra, low = lic, high = lc),
    step = "hv", marker = list(enabled = FALSE, visible = FALSE),
    type = "arearange", fillOpacity = 0.2, name = "", color = "blue",
    showInLegend = FALSE, tooltip = list(pointFormat = "{NULL}")
  ) |>
  hc_add_series(
    datos_u, type = "line", 
    hcaes(x = muestra, y = lsc), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCS</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_u,
    type = "line", hcaes(x = muestra, y = lc), useHTML = TRUE,
    color = "blue", name = "<b><i>LC</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list(valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_u, type = "line", hcaes(x = muestra, y = lic), useHTML = TRUE,
    color = "red", dashStyle = "Dash", name = "<b><i>LCI</b></i>",
    step = "hv", marker = list(enabled = FALSE),
    tooltip = list( valueDecimals = 2)
  ) |>
  hc_add_series(
    datos_u,
    type = "line", color = "black",
    hcaes(
      x = muestra, y = Ui
    ),
    marker = list(
      radius = 3
    ),
    useHTML = TRUE, name = "<b><i>U<sub>i</sub></i></b>",
    dashStyle = "Dash"
  ) |>
  hc_xAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Muestra (n<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_yAxis(
    title = list(
      useHTML = TRUE,
      text = "<b><i>Tasa de defectos (U<sub>i</sub>)</i></b><br>"
    )
  ) |>
  hc_tooltip(crosshairs = TRUE, shared = TRUE) |> 
  hc_plotOptions( series = list(animation = FALSE) )
```

Como se puede observar en la @fig-ejemplo-dcu-highcharter, el proceso funciona bajo control. Por lo que a la empresa del ramo pl치stico que fabrica productos de pl치stico las estimaciones realizadas les serviran de base para proximas inspecciones de los lotes de piezas en el proceso de producci칩n, para evaluar si el proceso sigue o no bajo control.
:::
::::

:::: {.callout-tip icon="false" appearance="simple"}
::: {#exm-dcu-tmv .Example}
### Aplicaci칩n del Diagrama $u$ con Tama침o de Muestra Variable

Se tienen los datos de acabado superficial en rollos de papel blanco, los mismos pueden observarse en la @tbl-datos-ejemplo2-dcu. El gerente de la empresa quiere saber cu치ntos defectos se encuentran en promedio por cada rollo de papel blanco. Por lo que se requiere aplicar un diagrama de control $u$.

```{r}
#| label: tbl-datos-ejemplo2-dcu
#| tbl-cap: "N칰mero de defectos por cada rollo de papel blanco"
#| tbl-align: left

datos_dutmv <- tibble(
  muestra = 1:28,
  ni = c(
    10L, 10L, 10L, 9L, 10L, 10L, 10L, 8L, 8L, 8L, 12L, 12L, 12L, 10L,
    10L, 11L, 10L, 10L, 10L, 10L, 10L, 10L, 11L, 10L, 10L, 10L, 9L, 10L 
  ),
  Ci = c(
    45L, 51L, 36L, 48L, 42L, 5L, 33L, 27L, 31L, 22L, 25L, 35L, 32L, 43L,
    48L, 35L, 39L, 29L, 37L, 33L, 15L, 33L, 27L, 23L, 25L, 41L, 37L, 28L
  ),
  Ui = Ci / ni
)

reactable::reactable(
  datos_dutmv,
  columns = list(
    muestra = colDef(
      header = "N칰mero de lote", align = "right"
    ),
    metros_cuadrados = colDef(
      header = "N칰mero de metros cuadrados", 
      align = "right"
    ),
    Ci = colDef(
      header = "N칰mero total de defectos", align = "right"
    ),
    ni = colDef(
      header = "Tama침o de muestra", align = "right",
      format = colFormat(
        separators = TRUE, digits = 1, locales = "es-ES"
      )
    ),
    Ui = colDef(
      header = "N칰mero de defectos por rollo de papel blanco", 
      align = "right",
      format = colFormat(
        separators = TRUE, digits = 4, locales = "es-ES"
      )
    )
  ),
  defaultColDef = colDef(
    # footer = function(values, name) {
    #   htmltools::div(name, style = list(fontWeight = 600))
    # },
    minWidth = 100,
    # maxWidth = 200
  ),
  fullWidth = TRUE,
  # width = "100%",
  # style = list(width = "100%"),
  resizable = TRUE, 
  wrap = FALSE, 
  bordered = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  highlight = TRUE,
  filterable = TRUE
)
```

La estimaci칩n de $u$ se obtiene mediante la siguiente expresi칩n:

$$
\begin{equation}
\bar{u}=\frac{\sum_{i=1}^{m}c_i}{\sum_{i=1}^{m}n_i}
\end{equation}
$$ {#eq-pustp}

La desviaci칩n estandar viene dada por:

$$
\begin{equation}
\sqrt{\frac{\bar{u}}{n_i}}
\end{equation}
$$

Los limites de control son calculados mediante las siguientes expresiones:

$$
\begin{align}
LCS_i = \bar{u}+3\sqrt{\frac{\bar{u}}{n_i}} \\
LC = \bar{u} \\ 
LCI_i = \bar{u}-3\sqrt{\frac{\bar{u}}{n_i}}
\end{align}
$$

Se observa en la @tbl-datos-ejemplo2-dcu que existe una similitud en los tama침os de muestra. Por ello, resulta m치s practica la estimaci칩n de estos limites utilizando el promedio de los $n$ subgrupos. Por lo que se utiliza la @eq-nest como se hizo con el @exm-dcp-tmv.

```{r}
#| include: FALSE
#| label: cp-dcu-tmv

m <- nrow(datos_dutmv)
n_est <-sum(datos_dutmv$ni)  / m
```

Al reemplazar los datos se tiene que:

$$
\bar{n}=\frac{
`r datos_dutmv$ni[1]` + `r datos_dutmv$ni[2]` + \cdots + `r datos_dutmv$ni[nrow(datos_dutmv)-1]` + `r datos_dutmv$ni[nrow(datos_dutmv)]`}{`r nrow(datos_dutmv)`} = `r round(n_est, 0)`.
$$

Por lo que ahora se calculan los nuevos limites de control utilizando la @eq-lcp, con la salvedad de que se utiliza $\bar{n}$ como estimador de los $n_i$.

```{r}
#| label: lc-dc-tmv
u_est <- sum(datos_dutmv$Ci) / sum(datos_dutmv$ni)
desviacion = sqrt(u_est / round(n_est,0))

lic_tmp <-  max(u_est - 3 * desviacion, 0)
lc <- u_est
lsc_tmp <- u_est + 3 * desviacion

# A칌ADIMOS LAS COLUMNAS AL DATAFRAME
datos_dutmv$lsc <- lsc_tmp
datos_dutmv$lic <- lic_tmp
datos_dutmv$u_est <- u_est
```

$$
LCS = `r u_est`+3\sqrt{\frac{`r u_est`}{`r round(n_est,0)`})} = `r lsc_tmp`
$$

$$
LC= `r u_est`=`r lc`
$$

$$
LCI = `r u_est`-3\sqrt{\frac{`r u_est`}{`r round(n_est,0)`})} = `r lic_tmp`
$$ De modo que, el diagrama de control con los l칤mites calculados ser칤a el siguiente:

```{r}
#| label: fig-ejemplo-dutmv-highcharter
#| fig-cap: "Diagrama $u$ para el n칰mero de defectos por cada rollo de papel blanco"

highchart() |>
  # 츼rea entre LCI y LC (azul)
  hc_add_series(
    data = datos_dutmv, 
    hcaes(x = muestra, low = lic, high = u_est),  # Corregido: orden correcto
    type = "arearange", 
    fillOpacity = 0.2, 
    color = "lightblue",
    name = "Zona control"
  ) |>
  # 츼rea entre LC y LCS (verde)
  hc_add_series(
    data = datos_dutmv, 
    hcaes(x = muestra, low = u_est, high = lsc),  # Corregido: orden correcto
    type = "arearange", 
    fillOpacity = 0.2, 
    color = "lightgreen",
    showInLegend = FALSE
  ) |>
  # L칤nea LCS
  hc_add_series(
    datos_dutmv, 
    type = "line", 
    hcaes(x = muestra, y = lsc), 
    color = "red", 
    dashStyle = "Dash", 
    name = "LCS",
    marker = list(enabled = FALSE)
  ) |>
  # L칤nea central
  hc_add_series(
    datos_dutmv,
    type = "line", 
    hcaes(x = muestra, y = u_est), 
    color = "blue", 
    name = "LC",
    marker = list(enabled = FALSE)
  ) |>
  # L칤nea LCI
  hc_add_series(
    datos_dutmv, 
    type = "line", 
    hcaes(x = muestra, y = lic), 
    color = "red", 
    dashStyle = "Dash", 
    name = "LCI",
    marker = list(enabled = FALSE)
  ) |>
  # Puntos de datos Ui
  hc_add_series(
    datos_dutmv,
    type = "line", 
    hcaes(x = muestra, y = Ui),
    color = "black",
    name = "U<sub>i</sub>",
    marker = list(radius = 4, symbol = "circle")
  ) |>
  hc_xAxis(title = list(text = "Muestra")) |>
  hc_yAxis(title = list(text = "Defectos por unidad (u<sub>i</sub>)")) |>
  hc_tooltip(
    headerFormat = "Muestra {point.x}<br/>",
    pointFormat = "{series.name}: {point.y:.4f}"
  ) |>
  hc_legend(enabled = TRUE)
```

Se puede observar que en la @fig-ejemplo-dutmv-highcharter el proceso se encuentra fuera control, ya que existen cuatro puntos fuera de los limites de control. Por lo que se sugiere investigar las causas de los defectos en los rollos de papel blanco, para poder tomar acciones correctivas y evitar que el proceso siga fuera de control.Por consiguiente, supondiendo causas atribuibles se sugiere su exclusi칩n con el fin de establecer una estimaci칩n de $u$ que ayude a supervisar las producciones futuras, el diagrama debe ser recalculado a partir de la estimaci칩n de $u$, utilizando la @eq-desvu, eliminando esta observaci칩n como se puede observar en R:

```{r}
datos_dutmv <- datos_dutmv[-c(2,4,6,21),]

u_est <- sum(datos_dutmv$Ci) / sum(datos_dutmv$ni)
desviacion = sqrt(u_est / round(n_est,0))

lic_tmp <-  max(u_est - 3 * desviacion, 0)
lc <- u_est
lsc_tmp <- u_est + 3 * desviacion

# A칌ADIMOS LAS COLUMNAS AL DATAFRAME
datos_dutmv$lsc <- lsc_tmp
datos_dutmv$lic <- lic_tmp
datos_dutmv$u_est <- u_est

```

```{r}
#| label: fig-ejemplo-dutmv2-highcharter
#| fig-cap: "Diagrama $u$ para el n칰mero de defectos por cada rollo de papel blanco"

highchart() |>
  # 츼rea entre LCI y LC (azul)
  hc_add_series(
    data = datos_dutmv, 
    hcaes(x = muestra, low = lic, high = u_est),  # Corregido: orden correcto
    type = "arearange", 
    fillOpacity = 0.2, 
    color = "lightblue",
    name = "Zona control"
  ) |>
  # 츼rea entre LC y LCS (verde)
  hc_add_series(
    data = datos_dutmv, 
    hcaes(x = muestra, low = u_est, high = lsc),  # Corregido: orden correcto
    type = "arearange", 
    fillOpacity = 0.2, 
    color = "lightgreen",
    showInLegend = FALSE
  ) |>
  # L칤nea LCS
  hc_add_series(
    datos_dutmv, 
    type = "line", 
    hcaes(x = muestra, y = lsc), 
    color = "red", 
    dashStyle = "Dash", 
    name = "LCS",
    marker = list(enabled = FALSE)
  ) |>
  # L칤nea central
  hc_add_series(
    datos_dutmv,
    type = "line", 
    hcaes(x = muestra, y = u_est), 
    color = "blue", 
    name = "LC",
    marker = list(enabled = FALSE)
  ) |>
  # L칤nea LCI
  hc_add_series(
    datos_dutmv, 
    type = "line", 
    hcaes(x = muestra, y = lic), 
    color = "red", 
    dashStyle = "Dash", 
    name = "LCI",
    marker = list(enabled = FALSE)
  ) |>
  # Puntos de datos Ui
  hc_add_series(
    datos_dutmv,
    type = "line", 
    hcaes(x = muestra, y = Ui),
    color = "black",
    name = "U<sub>i</sub>",
    marker = list(radius = 4, symbol = "circle")
  ) |>
  hc_xAxis(title = list(text = "Muestra")) |>
  hc_yAxis(title = list(text = "Defectos por unidad (u<sub>i</sub>)")) |>
  hc_tooltip(
    headerFormat = "Muestra {point.x}<br/>",
    pointFormat = "{series.name}: {point.y:.4f}"
  ) |>
  hc_legend(enabled = TRUE)
```

Como se puede observar en la @fig-ejemplo-dutmv2-highcharter todos los puntos se encuentran dentro de los limites. Por lo que el proceso se encuentra bajo control y el gerente de la empresa ya puede saber cu치ntos defectos que al encontrarse en promedio por cada rollo de papel blanco le permiten mantener la calidad del de acabado superficial en rollos de papel blanco.
:::
::::



## Referencias
